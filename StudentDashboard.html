<!DOCTYPE html>
<html lang="en" ng-app="myApp">


<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<meta name="description" content="">
<meta name="author" content="">
<link rel="icon" href="http://getbootstrap.com/favicon.ico">

<title>MTaaS</title>

<script src="public/stylesheets/js/angular.min.js"></script>
<script src="public/bower_components/Chart.js/Chart.js"></script>

<script type="text/javascript" src="/vis/dist/vis.js"></script>

<!-- Bootstrap core CSS -->
<link rel="stylesheet" href="public/stylesheets/css/bootstrap.min.css"/>
<link href="/vis/dist/vis.css" rel="stylesheet" type="text/css" />

<!-- Custom styles for this template -->
<link href="public/stylesheets/css/dashboard.css" rel="stylesheet"/>

<!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
<!--[if lt IE 9]>
<script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
<script src="public/stylesheets/js/ie-emulation-modes-warning.js"></script>

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="stylesheet" href="public/stylesheets/css/ng-table.min.css"/>
<script src="public/stylesheets/js/ng-table.min.js"></script>

<style type="text/css">
.red{
	background-color: red;
}
.green{
	background-color: green;
}
a{
	color: blue;
}


td, th {
	  text-align: center;
}
</style>

</head>


<body  ng-controller="StudentCtrl" ng-init="tab = 0">

<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Welcome! {{' '+user.first_name}}</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse" >
	    <ul class="nav navbar-nav navbar-right">
		   <li ><a href ng-click="tab = 0;viewTimeTable()">Reserve</a>
		   </li>
		   <li ><a href ng-click="tab = 1;viewBookings()">View Or Cancel Bookings</a>
		   </li>
		 <!--  <li><a href ng-click="tab = 4;OwnerActions()">Owner Activities</a>
		   </li>
		   <li><a href ng-click="tab = 2;rentPage()">Device Rental Records</a>
		   </li>
		   <li><a href ng-click="tab = 3;billPage()">Billing Metrics</a>
		   </li> -->
	       <li><a href ng-click="logout()"><span class='glyphicon glyphicon-log-out'></span> Log Out</a></li> 
	     </ul>
      <!--<form class="navbar-form navbar-right">
          <input type="text" class="form-control" placeholder="Search...">
        </form>-->
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!--<div class="col-sm-3 col-md-2 sidebar">
      <ul class="nav nav-sidebar" ng-init="tab = 0">
        <li ng-class="{ active:tab === 0 }"><a href ng-click="tab = 0;main()">Index<span class="sr-only">(current)</span></a>
        </li>
        <li ng-class="{ active:tab === 1 }"><a href ng-click="tab=1;postPage()">Device Post Records</a>
        </li>
        <li ng-class="{ active:tab === 4 }"><a href ng-click="tab=4;OwnerActions()">Owner Activities</a>
        </li>
        <li ng-class="{ active:tab === 2 }"><a href ng-click="tab = 2;rentPage()">Device Rental Records</a>
        </li>
        <li ng-class="{ active:tab === 3 }"><a href ng-click="tab = 3;billPage()">Billing Metrics</a>
        </li>
      </ul>
    </div>-->


    <div ng-show="tab === 0"  class="main">
    	<div class="col-sm-3">
              <label class="control-label" for="date">Date</label>
              <input type="date"  ng-change="changDate()" min="{{today}}" max ="{{max_day}}"  class="form-control " ng-model="s_date" placeholder="yyyy-mm-dd"}>

               <h4 class="control-label " >{{date_show}}</h4> 
        </div>

    
        <div class="panel panel-cascade panel-invoice">
        <div class="panel-body">
        <!--  <span class="pull-right" style="margin: 10px">
              <a href="#" class=" btn btn-success btn-print text-white hidden-print"><i class="fa fa-print"></i> Print</a>
          </span>-->

            <div class="row">

                <div class="col-md-12">

                	<span class="label label-success">Available</span>
        			    <span class="label label-danger">Not Available</span>

                    <table class="table table-bordered">

                        <thead>
                            <tr class="invoice-total" bgcolor="#f1f1f1">
                                <td><strong>Room</strong></td>
                                <td colspan="10"><strong>Time Slots</strong></td>

                            </tr>
                        </thead>


                        <tbody>

                        	<tr ng-repeat="room in rooms track by $index" >
                        		<th>
	                               {{room}}
	                           </th>
	                           <td ng-repeat="slot in slot_names track by $index"  ng-class='{red : check(room,$index), green: !check(room,$index)}' >

	                           	 <p><a ng-if="!check(room,$index)" ng-click="reserve(room,$index)">{{slot}}</a></p>

	                           	 <span ng-if="check(room,$index)">{{slot}}</span>

	                               
	                           </td>
	                        </tr>
                        	<!--<tr ng-repeat="room in roomTable.timesheet" >
                        		<th>
	                               {{room.roomNumber}}
	                           </th>

				                <td ng-repeat="slot in room.timeSlots" >
				                	 <a ng-if="slot.studentId==''" ng-click="reserve(roomTable.date, slot.timeSlot)"> {{slot_names[slot.timeSlot]}} </a>
                               		<span ng-if="slot.studentId!=''">{{slot_names[slot.timeSlot]}} </span>
				                 
				                </td>
				                
				        
				            </tr>-->

	                       
                       </tbody>
                    </table>
                </div>
            </div>
           </div>
         </div>
    </div>


 
 
   <div ng-show="tab === 1"  class="main">

    	
	    <div class="panel panel-cascade panel-invoice">
          <div class="panel-body">
	    	<h3 class="page-header">Here is your valid bookings</h3>        		    
		    <div>
		        <table class="table">

		            		<thead>
                            	<tr class="invoice-total" bgcolor="#f1f1f1">
                                	<td><strong>#</strong></td>
                                	<td><strong>Date</strong></td>
                                	<td><strong>Room</strong></td>
                                	<td><strong>Time</strong></td>
                                  <td></td>

                            	</tr>
                        	</thead>

                        	<tbody>


					            <tr ng-repeat="book in Records_data">
					            	<td data-title="'#'" >
			            				{{$index+1}}
			            			</td>
					            	<td data-title="'Date'" >
					            		{{book.date}}
					            	</td>
					            	<td data-title="'Room'">
					            		{{book.roomid}}
					            	</td>
					            	<td data-title="'Time'">
					            		{{slot_names[book.slot]}}
					            	</td>
					            	<td>
				                    	<a  ng-click="cancelBooking(book,$index+1)"><span>Cancel</span></a>  
				                    
				                </td>          
		      	          </tr>
		      	            </tbody>
		      	</table>
		    </div>
		  </div>
		</div> 
	</div>
</div>
</div>

</body>    

<script>
  var app = angular.module('myApp', ['ngTable']);
  app.controller('StudentCtrl', function($scope,$http,$filter, ngTableParams) {

  		$scope.rooms=[226,322,324,326,390,392,602,604,622,624,626,632,634,662,664,702,704,706,722,724,726,732,734,762,764,862,804,806,822,824,826,832,834,862,864];


      //var url='http://54.186.74.110:8080';

      var url='http://localhost:8080';
      //alert(window.location.href);
    
      var names=window.location.href.split('=');
      $scope.sid=names[1];
     


       var sqs=function(date){


          AWS.config.update({accessKeyId: 'AKIAIFHRDHCVYUE7LEPA', secretAccessKey: 'IcOnQSEBwjIk7j9WJZ7SMR5cBeBfaLGl8jEMT5xV'});

    // Configure your region
          AWS.config.region = 'us-west-2';

          var s_url='https://sqs.us-west-2.amazonaws.com/154194788582/CMPE282-FB';
          var r_url='https://sqs.us-west-2.amazonaws.com/154194788582/CMPE282-BF';

          var queue = new AWS.SQS({params: {QueueUrl: s_url}});
          var data={
              "date":'date'
          };
          
          queue.sendMessage({MessageBody: JSON.stringify(data)}, function (err, data) {
                  if (!err) alert('Message sent.');
          });


          var queue_r = new AWS.SQS({params: {QueueUrl: r_url}});


           var data_res={

              "date": "2016-05-05",
              "timesheet": [
                   {
                      "roomNumber": "479",
                      "timeSlots": [
                          {
                              "timeSlot": 9,
                              "studentId": "123"
                          },
                          {
                              "timeSlot": 1,
                              "studentId": "123"
                          }
                      ]
                  }
              ]
          };

          queue_r.sendMessage({MessageBody: JSON.stringify(data_res)}, function (err, data) {
                    if (!err) alert('Message sent.');
            });


        
          queue.receiveMessage(function (err, data) {
              if (data) {
                  alert('receiveMessage '); // message data in Messages structure
                  for (var name in data.Messages[0].Body) {
                  // name is the name of each property, so:
                      console.log(name + " = " + data.Messages[0].Body[name]);
                  }
                  var res=JSON.parse(data.Messages[0].Body);

                  alert(res.user);
                 


                  
              }
          });

          queue_r.receiveMessage(function (err, data) {
              if (data) {
                  alert('receiveMessage '); // message data in Messages structure
                  for (var name in data.Messages[0].Body) {
                  // name is the name of each property, so:
                      console.log(name + " = " + data.Messages[0].Body[name]);
                  }
                  var res=JSON.parse(data.Messages[0].Body);

                  alert(res.user);
                 


                  
              }
          });


       };


  		


  		var month_names = [
                            'January',
                            'February',
                            'March',
                            'April',
                            'May',
                            'June',
                            'July',
                            'August',
                            'September',
                            'October',
                            'November',
                            'December'
                        ];
        var day_names = [
                            'Sunday',
                            'Monday',
                            'Tuesday',
                            'Wednesday',
                            'Thursday',
                            'Friday',
                            'Saturday'
                            
                        ];

         $scope.slot_names = [
                            '8:00 AM - 9:00 AM',
                            '9:00 AM - 10:00 AM',
                            '10:00 AM - 11:00 AM',
                            '11:00 AM - 12:00 PM',
                            '12:00 PM - 1:00 PM',
                            '1:00 PM - 2:00 PM',
                            '2:00 AM - 3:00 PM',
                            '3:00 AM - 4:00 PM',
                            '4:00 AM - 5:00 PM',
                            '5:00 AM - 6:00 PM'
                            
                        ];


        $scope.viewTimeTable = function(){

          showTable(formateDate($scope.s_date));


        }

    
         $scope.check = function(room,slot_id){

          var r=false,s=false;


          var timesheet=$scope.roomTable.timesheet;

          

          for(x in timesheet){

            if(timesheet[x].roomNumber==room){
              //alert(timesheet[x].roomNumber);
              r=true;

              if(r==true){

                var slots=timesheet[x].timeSlots;
                
                if(slots.length>0){

                  for(y in slots){
                    if(slots[y].timeSlot==slot_id){
                      //alert(slots[y].timeSlot);
                      s=true; 
                     // alert(r&&s);   
                      return r&&s;
                      //alert('slots:'+slots[y].timeSlot+'=='+slot_id+'?'+s);
                    }
                  }
                }
              }
            }   
          }
          return r&&s;
        };

       $scope.reserve= function(room,slot_id){

        	if(confirm("Reserve "+room+"?")){

           // alert('reserve'+formateDate($scope.s_date));

    				$http({
    					method: 'POST',
    					url: url+'/book?sid='+$scope.sid,

              withCredentials: true,
    						         // data: {"type":$scope.header,"device":book}
    					data: {
                  "date": formateDate($scope.s_date),
                  "roomid": room,
    							"slot": slot_id
    							
    						}
    		
    					}).success(function (res,status) {
    						if(status=='203'){

                        alert('Invalid Time: Time Passed!');

                }else{
    						  showTable(formateDate($scope.s_date));
                }

    					}).error(function(res,status){

                   // alert('err status:'+status);
                    /*for(var propt in res){
                      alert(propt + ': ' + res[propt]);
                    }*/
                    
                    if(status=='406'){

                        alert('You have reached the maxium number of bookings!');

                    }

              });
			   }
        };

        $scope.cancelBooking= function(book,index){

         // alert(book.date+' '+book.roomid+' '+book.slot);

        	if(confirm("Cancel Booking "+index+"?")){

	        	$http({
    					method: 'DELETE',
    					url: url+'/book?sid='+$scope.sid,
              withCredentials: true,
    					data:{

                  "date": book.date,
                  "roomid": book.roomid,
    							"slot": book.slot
    							
    					},
              
              headers: {"Content-Type": "application/json;charset=utf-8"}

    		
    					}).success(function(res) {
    						  bookingViews();

    					}).error(function(res,status){

                   /* alert('err status:'+status);
                    for(var propt in res){
                      alert(propt + ': ' + res[propt]);
                    }
                    */

              });
			     }

        };		

  		$scope.s_date=new Date();
  		$scope.date_show=day_names[$scope.s_date.getDay()]+', '+month_names[$scope.s_date.getMonth()]+' '+ $scope.s_date.getDate()+', '+$scope.s_date.getFullYear();

    

      var formateDate=function(date){
          //alert(date);
          var d=date.getDate();
          var m=date.getMonth()+1;
          var y=date.getFullYear();
          return '' + y + '-' + (m<=9 ? '0' + m : m) + '-' + (d <= 9 ? '0' + d : d);

      }
  		 var showTable=function(datetime){
          //alert(datetime);
  		 //alert($scope.s_date.toISOString().substring(0,10));

  		 	 //alert('http://54.186.74.110:8080/timetable/'+datetime);
  			//$http.get('http://54.186.74.110:8080/timetable/'+datetime).success(function(res) {
  			 $http({
		          method: 'GET',
		          url: url+'/timetable/'+datetime        

			   }).success(function(res) {

  				  //alert('result:'+res);


				    $scope.roomTable=res;
        }).error(function(res,status){
             $scope.roomTable={};
        });	

  		 };

  		showTable(formateDate($scope.s_date));

  		$scope.changDate=function(){
        

       
  			$scope.date_show=day_names[$scope.s_date.getDay()]+', '+month_names[$scope.s_date.getMonth()]+' '+ $scope.s_date.getDate()+', '+$scope.s_date.getFullYear();
  			showTable(formateDate($scope.s_date));

  		};

		
  		var c_day=new Date();
  		var m_day=new Date();
  		$scope.today=formateDate(c_day);	
      //alert($scope.today);
  		var numOfDays=4;		
  		m_day.setTime(c_day.getTime()+numOfDays*24 * 60 * 60 * 1000);
  		$scope.max_day=formateDate(m_day);
      //alert($scope.max_day);


      var bookingViews=function(){

         $http({
              method: 'GET',
              withCredentials: true,
              url: url+'/student?sid='+$scope.sid      

         }).success(function(res) {

            //alert('result:'+res);


            $scope.Records_data=res.reservation;
        }).error(function(res,status){

          /*alert(status);
          for(var propt in res){
              alert(propt + ': ' + res[propt]);
          }*/
             $scope.Records_data={};
        }); 

      }


  		$scope.viewBookings=function(){

       bookingViews();

        
  		};



  		$scope.logout=function(){

  			window.location.assign('login.html');	
			/* $http({
		          method: 'post',
		          url: url+'/signout',
              withCredentials: true
		      

			 }).success(function(res,status) {
        alert(status);

				window.location.assign('/');
			 }).error(function(res,status){

          alert(status);

        }); */
		};
    
  });
</script>


<!-- Bootstrap core JavaScript
  ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/stylesheets/js/jquery.min.js"></script>
<script src="/stylesheets/js/bootstrap.min.js"></script>
<!-- Just to make our placeholder images work. Don't actually copy the next line! -->
<script src="/stylesheets/js/holder.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="/stylesheets/js/ie10-viewport-bug-workaround.js"></script>

</body>

</html>